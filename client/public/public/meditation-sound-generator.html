<!DOCTYPE html>
<html>
<head>
  <title>Meditation Sound Generator</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
    button { padding: 10px 20px; margin: 10px 0; }
    .controls { margin: 20px 0; }
  </style>
</head>
<body>
  <h1>Meditation Sound Generator</h1>
  <p>Click the button below to start generating peaceful meditation sounds. Click again to stop.</p>
  
  <button id="toggleButton">Start Sound</button>
  <button id="downloadButton" disabled>Download as MP3</button>
  
  <div class="controls">
    <label for="baseFrequency">Base Frequency: </label>
    <input type="range" id="baseFrequency" min="50" max="200" value="136" />
    <span id="baseFrequencyValue">136 Hz</span>
  </div>
  
  <script>
    // Audio context
    let audioCtx;
    let isPlaying = false;
    let oscillators = [];
    let mediaRecorder;
    let audioChunks = [];
    
    // DOM elements
    const toggleButton = document.getElementById('toggleButton');
    const downloadButton = document.getElementById('downloadButton');
    const baseFrequencySlider = document.getElementById('baseFrequency');
    const baseFrequencyValue = document.getElementById('baseFrequencyValue');
    
    // Update base frequency display
    baseFrequencySlider.addEventListener('input', () => {
      baseFrequencyValue.textContent = `${baseFrequencySlider.value} Hz`;
    });
    
    // Toggle sound generation
    toggleButton.addEventListener('click', () => {
      if (!isPlaying) {
        startSound();
        toggleButton.textContent = 'Stop Sound';
        downloadButton.disabled = true;
      } else {
        stopSound();
        toggleButton.textContent = 'Start Sound';
      }
    });
    
    // Download recorded audio
    downloadButton.addEventListener('click', () => {
      const audioBlob = new Blob(audioChunks, { type: 'audio/mpeg' });
      const audioUrl = URL.createObjectURL(audioBlob);
      const link = document.createElement('a');
      link.href = audioUrl;
      link.download = 'meditation-sounds.mp3';
      link.click();
    });
    
    function startSound() {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      isPlaying = true;
      audioChunks = [];
      
      // Create master gain
      const masterGain = audioCtx.createGain();
      masterGain.gain.value = 0.3;
      masterGain.connect(audioCtx.destination);
      
      // Record audio stream
      const destination = audioCtx.createMediaStreamDestination();
      masterGain.connect(destination);
      
      mediaRecorder = new MediaRecorder(destination.stream);
      mediaRecorder.addEventListener('dataavailable', event => {
        audioChunks.push(event.data);
      });
      
      mediaRecorder.addEventListener('stop', () => {
        downloadButton.disabled = false;
      });
      
      mediaRecorder.start();
      
      // Base frequency (OM frequency - 136.1 Hz)
      const baseFreq = parseFloat(baseFrequencySlider.value);
      
      // Create beautiful chord with harmonics
      createOscillator(baseFreq, 'sine', 0.6, masterGain);
      createOscillator(baseFreq * 1.5, 'sine', 0.3, masterGain);
      createOscillator(baseFreq * 2, 'sine', 0.2, masterGain);
      
      // Add gentle nature sound layers
      createNoiseLayer(masterGain, 0.05);
      
      // Add gentle pulsing effect
      const pulsingGain = audioCtx.createGain();
      pulsingGain.gain.value = 0.15;
      
      const pulsingOsc = audioCtx.createOscillator();
      pulsingOsc.type = 'sine';
      pulsingOsc.frequency.value = 0.1; // Very slow pulsing
      
      const pulsingDepth = audioCtx.createGain();
      pulsingDepth.gain.value = 0.1;
      
      pulsingOsc.connect(pulsingDepth);
      pulsingDepth.connect(pulsingGain.gain);
      pulsingGain.connect(masterGain);
      
      createOscillator(baseFreq * 0.5, 'sine', 0.2, pulsingGain);
      
      pulsingOsc.start();
      oscillators.push(pulsingOsc);
      
      // Create bell sounds
      setInterval(() => {
        if (isPlaying) {
          createBellSound(masterGain);
        }
      }, 8000); // Bell sound every 8 seconds
    }
    
    function createOscillator(freq, type, gain, destination) {
      const osc = audioCtx.createOscillator();
      osc.type = type;
      osc.frequency.value = freq;
      
      const oscGain = audioCtx.createGain();
      oscGain.gain.value = gain;
      
      osc.connect(oscGain);
      oscGain.connect(destination);
      
      // Gentle fade in
      oscGain.gain.setValueAtTime(0, audioCtx.currentTime);
      oscGain.gain.linearRampToValueAtTime(gain, audioCtx.currentTime + 2);
      
      osc.start();
      oscillators.push(osc);
      return osc;
    }
    
    function createNoiseLayer(destination, gain) {
      const bufferSize = 2 * audioCtx.sampleRate;
      const noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
      const output = noiseBuffer.getChannelData(0);
      
      for (let i = 0; i < bufferSize; i++) {
        output[i] = Math.random() * 2 - 1;
      }
      
      const noise = audioCtx.createBufferSource();
      noise.buffer = noiseBuffer;
      noise.loop = true;
      
      // Create filters for white noise to make it sound like gentle wind/water
      const lowpass = audioCtx.createBiquadFilter();
      lowpass.type = 'lowpass';
      lowpass.frequency.value = 400;
      lowpass.Q.value = 0.5;
      
      const highpass = audioCtx.createBiquadFilter();
      highpass.type = 'highpass';
      highpass.frequency.value = 100;
      
      const noiseGain = audioCtx.createGain();
      noiseGain.gain.value = gain;
      
      noise.connect(highpass);
      highpass.connect(lowpass);
      lowpass.connect(noiseGain);
      noiseGain.connect(destination);
      
      noise.start();
      oscillators.push(noise);
    }
    
    function createBellSound(destination) {
      // Random bell frequency based on pentatonic scale
      const pentatonic = [1, 1.2, 1.5, 1.8, 2];
      const baseFreq = parseFloat(baseFrequencySlider.value);
      const randomNote = pentatonic[Math.floor(Math.random() * pentatonic.length)];
      const bellFreq = baseFreq * randomNote * 2; // Higher octave for bell
      
      const bell = audioCtx.createOscillator();
      bell.type = 'sine';
      bell.frequency.value = bellFreq;
      
      const bellGain = audioCtx.createGain();
      bellGain.gain.value = 0;
      
      // Bell envelope
      bellGain.gain.setValueAtTime(0, audioCtx.currentTime);
      bellGain.gain.linearRampToValueAtTime(0.2, audioCtx.currentTime + 0.01);
      bellGain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 5);
      
      bell.connect(bellGain);
      bellGain.connect(destination);
      
      bell.start();
      bell.stop(audioCtx.currentTime + 5);
    }
    
    function stopSound() {
      isPlaying = false;
      
      // Fade out all oscillators
      oscillators.forEach(osc => {
        if (osc.gain) {
          osc.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 1);
          setTimeout(() => osc.stop(), 1000);
        } else {
          osc.stop();
        }
      });
      
      oscillators = [];
      
      setTimeout(() => {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
          mediaRecorder.stop();
        }
        if (audioCtx) {
          audioCtx.close();
        }
      }, 1000);
    }
  </script>
</body>
</html>